FROM bitnami/keycloak:23.0.6-debian-11-r19 AS builder

ENV KC_METRICS_ENABLED=true
ENV KC_HTTP_RELATIVE_PATH=/beauty-keycloak
ENV KC_HEALTH_ENABLED=true

ENV KC_DB=postgres
ENV KC_TRANSACTION_XA_ENABLED=false
COPY beauty-keycloak.jar /opt/bitnami/keycloak/providers/
COPY cache-ispn.xml /opt/bitnami/keycloak/conf/
ENV KC_CACHE=ispn
ENV KC_CACHE_CONFIG_FILE=cache-ispn.xml
ENV KC_CACHE_STACK=tcp
#ENV KC_CACHE_REMOTE_HOST=beauty-infinispan-server
#ENV KC_CACHE_REMOTE_USERNAME=admin
#ENV KC_CACHE_REMOTE_PASSWORD=admin
#ENV KC_CACHE_REMOTE_PORT=11222
#ENV KC_CACHE_REMOTE_TLS_ENABLED=true



RUN /opt/bitnami/keycloak/bin/kc.sh build

FROM bitnami/keycloak:23.0.6-debian-11-r19
COPY --from=builder /opt/bitnami/keycloak/ /opt/bitnami/keycloak/
WORKDIR /opt/bitnami/keycloak
ARG env_db_url
ARG apic_org_key
ARG admin_hostname

ENV KC_HOSTNAME_PATH=/$apic_org_key/7/site-controller-api/auth/
ENV KC_HOSTNAME_ADMIN_URL=https://$admin_hostname/$apic_org_key/7/site-controller-api/auth/
ENV KC_LOG=file,console
ENV KC_LOG_FILE_OUTPUT=json
ENV KC_LOG_LEVEL=INFO
ENV KC_LOG_FILE=/var/log/app/stdout.json

ENV KC_PROXY=edge
# superfluous since included in proxy=edge
ENV KC_HTTP_ENABLED=true
ENV KC_HOSTNAME_STRICT=false
ENV KC_HOSTNAME_STRICT_HTTPS=false

ENV KC_DB=postgres
ENV KC_DB_URL=$env_db_url
ENV KC_DB_USERNAME=beauty
ENV KC_DB_PASSWORD=beauty
ENV KC_DB_POOL_MAX_SIZE=3

ENV KEYCLOAK_ADMIN=admin
ENV KEYCLOAK_ADMIN_PASSWORD=admin

ENV PROXY_ADDRESS_FORWARDING=true
#ENV KC_CACHE=ispn
#ENV KC_CACHE_STACK=kubernetes
ENV JAVA_OPTS_APPEND=-Djgroups.dns.query=beauty-keycloak-headless-service

ENTRYPOINT ["/opt/bitnami/keycloak/bin/kc.sh", "start", "--optimized"]
